name: Build Installer
on:
  workflow_dispatch:
  push:
    paths: ["hook/**", "dist/**", "installer/**", "tools/uprooted_profiler.*", ".github/workflows/**"]

jobs:
  build:
    runs-on: windows-latest
    env:
      CC: cl.exe
      CXX: cl.exe
      CARGO_TARGET_X86_64_PC_WINDOWS_MSVC_LINKER: link.exe
    steps:
      - uses: actions/checkout@v4
      - uses: ilammy/msvc-dev-cmd@v1
      - uses: actions/setup-dotnet@v4
        with: { dotnet-version: "10.0.x", dotnet-quality: "preview" }
      - uses: actions/setup-node@v4
        with: { node-version: "22" }
      - uses: pnpm/action-setup@v4
        with: { version: 10 }
      - uses: dtolnay/rust-toolchain@stable
      - uses: Swatinem/rust-cache@v2
        with: { workspaces: installer/src-tauri }

      - run: pnpm install --frozen-lockfile

      - name: Stage artifacts
        run: |
          New-Item -ItemType Directory -Path installer\src-tauri\artifacts -Force
          Copy-Item dist\uprooted-preload.js installer\src-tauri\artifacts\
          Copy-Item dist\uprooted.css installer\src-tauri\artifacts\

      - name: Build UprootedHook.dll
        run: dotnet build hook -c Release -o hook/_out

      - name: Stage Hook DLL
        run: |
          Copy-Item hook\_out\UprootedHook.dll installer\src-tauri\artifacts\
          Copy-Item hook\_out\UprootedHook.deps.json installer\src-tauri\artifacts\

      - name: Compile profiler DLL
        run: cl.exe /LD /O2 /Fe:installer\src-tauri\artifacts\uprooted_profiler.dll tools\uprooted_profiler.c /link ole32.lib kernel32.lib shell32.lib /DEF:tools\uprooted_profiler.def

      - name: Verify artifacts
        run: |
          $files = @("uprooted_profiler.dll","UprootedHook.dll","UprootedHook.deps.json","uprooted-preload.js","uprooted.css")
          foreach ($f in $files) {
            $p = "installer\src-tauri\artifacts\$f"
            if (-not (Test-Path $p)) { throw "Missing: $f" }
            if ((Get-Item $p).Length -eq 0) { throw "Empty: $f" }
            Write-Host "  $f ($((Get-Item $p).Length) bytes)"
          }

      - name: Build Tauri
        working-directory: installer
        run: pnpm tauri build

      - name: Rename portable exe
        run: |
          $version = (Get-Content installer\src-tauri\tauri.conf.json | ConvertFrom-Json).version
          Copy-Item "installer\src-tauri\target\release\uprooted-installer.exe" "installer\src-tauri\target\release\Uprooted-$version.exe"
          Write-Host "Renamed to Uprooted-$version.exe"

      - name: Upload
        uses: actions/upload-artifact@v4
        with:
          name: Uprooted
          path: installer/src-tauri/target/release/Uprooted-*.exe
