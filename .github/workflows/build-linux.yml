name: Build Linux Installer

on:
  workflow_dispatch:
  push:
    paths:
      - "hook/**"
      - "src/**"
      - "installer/**"
      - "tools/uprooted_profiler_linux.c"
      - "packaging/arch/**"
      - ".github/workflows/build-linux.yml"

jobs:
  build-linux:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      # ── Toolchains ──

      - name: Install system dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y libwebkit2gtk-4.1-dev libappindicator3-dev \
            librsvg2-dev patchelf gcc

      - name: Setup .NET 10 Preview
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: "10.0.x"
          dotnet-quality: "preview"

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "22"

      - name: Setup pnpm
        uses: pnpm/action-setup@v4
        with:
          version: 10

      - name: Setup Rust
        uses: dtolnay/rust-toolchain@stable

      - name: Rust cache
        uses: Swatinem/rust-cache@v2
        with:
          workspaces: installer/src-tauri

      # ── Install deps ──

      - name: Install Node dependencies
        run: pnpm install --frozen-lockfile

      # ── Build artifacts ──

      - name: Create artifacts directory
        run: mkdir -p installer/src-tauri/artifacts

      - name: Build TypeScript layer
        run: pnpm build

      - name: Stage JS + CSS
        run: |
          cp dist/uprooted-preload.js installer/src-tauri/artifacts/
          cp dist/uprooted.css installer/src-tauri/artifacts/

      - name: Build UprootedHook.dll
        run: dotnet build hook -c Release -o hook/_out

      - name: Stage Hook DLL + deps
        run: |
          cp hook/_out/UprootedHook.dll installer/src-tauri/artifacts/
          cp hook/_out/UprootedHook.deps.json installer/src-tauri/artifacts/

      - name: Compile profiler .so
        run: gcc -shared -fPIC -O2 -o installer/src-tauri/artifacts/libuprooted_profiler.so tools/uprooted_profiler_linux.c

      - name: Verify staged artifacts
        run: |
          for f in libuprooted_profiler.so UprootedHook.dll UprootedHook.deps.json uprooted-preload.js uprooted.css; do
            path="installer/src-tauri/artifacts/$f"
            [ -f "$path" ] || { echo "Missing: $f"; exit 1; }
            [ -s "$path" ] || { echo "Empty: $f"; exit 1; }
            echo "  $f ($(stat -c%s "$path") bytes)"
          done

      # ── Build Tauri ──

      - name: Build Tauri for Linux
        working-directory: installer
        run: pnpm tauri build --bundles deb appimage

      - name: List bundle outputs
        run: |
          echo "=== deb ==="
          ls -la installer/src-tauri/target/release/bundle/deb/ 2>/dev/null || echo "No deb output"
          echo "=== appimage ==="
          ls -la installer/src-tauri/target/release/bundle/appimage/ 2>/dev/null || echo "No appimage output"

      - name: Upload .deb
        uses: actions/upload-artifact@v4
        with:
          name: Uprooted-Linux-deb
          path: installer/src-tauri/target/release/bundle/deb/*.deb

      - name: Upload AppImage
        uses: actions/upload-artifact@v4
        with:
          name: Uprooted-Linux-AppImage
          path: installer/src-tauri/target/release/bundle/appimage/*.AppImage

  # ── Arch Linux Package ──
  # Repackages the .deb into a native .pkg.tar.zst for pacman

  build-arch:
    needs: build-linux
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          sparse-checkout: |
            packaging/arch
            installer/src-tauri/tauri.conf.json

      - name: Download .deb artifact
        uses: actions/download-artifact@v4
        with:
          name: Uprooted-Linux-deb
          path: ./deb-artifact/

      - name: Prepare PKGBUILD
        run: |
          VERSION=$(jq -r '.version' installer/src-tauri/tauri.conf.json)
          DEB_FILE=$(ls deb-artifact/*.deb | head -1)
          DEB_NAME=$(basename "$DEB_FILE")
          SHA256=$(sha256sum "$DEB_FILE" | awk '{print $1}')

          echo "Version: $VERSION"
          echo "Deb: $DEB_NAME"
          echo "SHA256: $SHA256"

          mkdir -p uprooted-bin
          cp "$DEB_FILE" uprooted-bin/
          sed -e "s|%%VERSION%%|${VERSION}|g" \
              -e "s|%%DEB_NAME%%|${DEB_NAME}|g" \
              -e "s|%%SHA256%%|${SHA256}|g" \
              packaging/arch/PKGBUILD > uprooted-bin/PKGBUILD

          echo "=== Generated PKGBUILD ==="
          cat uprooted-bin/PKGBUILD

      - name: Build Arch package
        uses: 2m/arch-pkgbuild-builder@v1.17
        with:
          target: pkgbuild
          pkgname: uprooted-bin

      - name: Upload .pkg.tar.zst
        uses: actions/upload-artifact@v4
        with:
          name: Uprooted-Arch
          path: uprooted-bin/*.pkg.tar.zst
